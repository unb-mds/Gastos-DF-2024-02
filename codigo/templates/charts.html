{% extends 'base.html' %}

{% block title %}Análise de Gastos{% endblock %}

{% block content %}
<!-- Barra de navegação -->
<div id="barra-navegacao" style="margin-top: -38px;"> 
    <a href="{{ url_for('charts') }}" class="nav-link active">Gráficos</a>
    <a href="{{ url_for('tables') }}" class="nav-link">Tabelas</a>
</div>

<!-- Conteúdo principal -->
<div class="content">
    <h2 style="text-align: center;">Monitoramento de Gastos Públicos - DF</h2>

    <!-- Div para gráfico de compras -->
    <div id="grafico-compras-container" style="width: 90%; margin: 0 auto; background-color: #f3f7fa; border-radius: 10px; margin-bottom: 20px; padding: 20px;">
        <h3 style="text-align: center;">Gastos com Compras</h3>
        <div id="grafico-compras" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- Divs para gráficos de despesas por órgão -->
    {% for orgao, dados in despesas_por_orgao.items() %}
        <div id="grafico-{{ orgao|replace(' ', '_') }}-container" style="width: 90%; margin: 0 auto; background-color: #f3f7fa; border-radius: 10px; margin-bottom: 20px; padding: 20px;">
            <h3 style="text-align: center;">Despesas - {{ orgao.split(' ', 1)[1] }}</h3>
            <div id="grafico-{{ orgao|replace(' ', '_') }}" style="width: 100%; height: 400px;"></div>
        </div>
    {% endfor %}
</div>

<!-- Scripts para os gráficos -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const compras = {{ compras | tojson | safe }};
    const despesasPorOrgao = {{ despesas_por_orgao | tojson | safe }};

    function renderizarGrafico(id, dados) {
        if (!dados || !dados.labels || !dados.empenhado || dados.labels.length === 0) {
            document.getElementById(id).innerHTML = `<p style="text-align: center; color: #555;">Não há dados para exibir no momento.</p>`;
            return;
        }

        const data = [
            {
                x: dados.labels,
                y: dados.empenhado,
                type: 'bar',
                name: 'Empenhado',
                marker: { color: '#1f77b4' }
            },
            {
                x: dados.labels,
                y: dados.liquidado,
                type: 'bar',
                name: 'Liquidado',
                marker: { color: '#ff7f0e' }
            },
            {
                x: dados.labels,
                y: dados.pago,
                type: 'bar',
                name: 'Pago',
                marker: { color: '#2ca02c' }
            }
        ];

        const layout = {
            xaxis: { title: 'Ano' },
            yaxis: { title: 'Valor (R$)' },
            barmode: 'group',
            autosize: true,
            width: document.getElementById(id).clientWidth - 20,
            height: 400,
            plot_bgcolor: "#f3f7fa",
            paper_bgcolor: "#f3f7fa",
            font: { color: '#333' },
            margin: { t: 20, l: 50, r: 50, b: 50 }, // Reduzimos o topo (t) para remover espaço extra
        };

        Plotly.newPlot(id, data, layout, { displayModeBar: false }); // Desabilita barra de ferramentas interativa
    }

    // Renderiza gráfico de compras
    renderizarGrafico('grafico-compras', compras);

    // Renderiza gráficos de despesas por órgão
    Object.entries(despesasPorOrgao).forEach(([orgao, dados]) => {
        const divId = `grafico-${orgao.replace(/\s/g, '_')}`;
        renderizarGrafico(divId, dados);
    });
</script>
{% endblock %}
