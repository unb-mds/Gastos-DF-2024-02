{% extends 'base.html' %}

{% block content %}
<!-- Barra de navegação -->
<div id="barra-navegacao">
  <a href="{{ url_for('charts') }}" class="nav-link">Gráficos</a>
  <a href="{{ url_for('tables') }}" class="nav-link active">Tabelas</a>
</div>

<!-- Conteúdo principal -->
<div class="content">
  <h2 style="text-align: center; margin-bottom: 20px;">Monitoramento de Gastos Públicos</h2>

  <!-- Menu dropdown para escolha -->
  <div class="dropdown">
    <button class="dropdown-btn">Escolher</button>
    <div class="dropdown-content">
      <a href="#" onclick="showSection('compras'); return false;">Gastos com Compras</a>
      <p style="margin-left: 10px; font-weight: bold;">Órgãos de Despesas:</p>
      {% for orgao, _ in despesas_por_orgao.items() %}
        <a href="#" onclick="showSpecificDespesas('{{ orgao }}'); return false;">
          {{ orgao.split(' ', 1)[1] }}
        </a>
      {% endfor %}
    </div>
  </div>

  <!-- Formulário de pesquisa -->
  <div class="search-container" id="search-container" style="display: flex; justify-content: center; margin: 20px 0;">
    <input
      id="search-input"
      type="text"
      placeholder="Pesquisar..."
      class="search-input"
      style="padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 5px;"
    />
    <button onclick="searchTable()" class="search-button" style="padding: 10px 20px; margin-left: 10px; background-color: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer;">
      Pesquisar
    </button>
  </div>

  <!-- Tabelas de despesas -->
  <div id="despesas-container" style="display: none;">
    <h3 id="despesas-title" style="text-align: center; font-size: 20px; margin-bottom: 20px;">Gastos com Despesas Gerais</h3>
    {% for orgao, despesas in despesas_por_orgao.items() %}
      <div class="despesas-orgao" id="despesas-{{ orgao }}" style="margin-bottom: 30px;">
        <h4 style="text-align: center; font-size: 18px; color: #333;">{{ orgao.split(' ', 1)[1] }}</h4>
        <table class="data-table" style="width: 100%; border-collapse: collapse; margin: 0 auto; text-align: left;">
          <thead>
            <tr style="background-color: #f4f4f4; border-bottom: 2px solid #ddd;">
              <th>Ano</th>
              <th>Órgão</th>
              <th>Código do Órgão</th>
              <th>Empenhado</th>
              <th>Liquidado</th>
              <th>Pago</th>
            </tr>
          </thead>
          <tbody>
            {% for item in despesas %}
            <tr>
              <td>{{ item.ano }}</td>
              <td>{{ item.orgao }}</td>
              <td>{{ item.codigoOrgao }}</td>
              <td>R$ {{ "%.2f"|format(item.empenhado) }}</td>
              <td>R$ {{ "%.2f"|format(item.liquidado) }}</td>
              <td>R$ {{ "%.2f"|format(item.pago) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

  <!-- Tabela de compras -->
  <div id="compras-container">
    <h3 style="text-align: center; font-size: 20px; margin-bottom: 20px;">Gastos com Compras</h3>
    <table class="data-table" style="width: 100%; border-collapse: collapse; margin: 0 auto; text-align: left;">
      <thead>
        <tr style="background-color: #f4f4f4; border-bottom: 2px solid #ddd;">
          <th>Empresa</th>
          <th>CNPJ</th>
          <th>Objeto</th>
          <th>Valor</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <!-- Dados preenchidos dinamicamente -->
      </tbody>
    </table>
    <p id="result-count" class="result-count" style="text-align: center; margin-top: 10px;">Exibindo 0 resultado(s).</p>
  </div>
</div>

<script>
  // Dados enviados pelo Flask
  const compras = {{ compras|safe }};
  const despesasPorOrgao = {{ despesas_por_orgao|tojson }};
  let currentData = [];
  let currentSection = "compras";

  // Renderizar a tabela de compras
  function renderTable(data) {
    const tbody = document.querySelector("#table-body");
    const resultCount = document.querySelector("#result-count");
    tbody.innerHTML = ""; // Limpar tabela existente

    if (data.length === 0) {
      resultCount.textContent = "Nenhum resultado encontrado.";
      return;
    }

    data.forEach((item) => {
      const row = `<tr>
        <td>${item.empresa}</td>
        <td>${item.cnpj}</td>
        <td>${item.objeto}</td>
        <td>R$ ${item.valor.toFixed(2)}</td>
        <td>${item.data}</td>
      </tr>`;
      tbody.innerHTML += row;
    });

    resultCount.textContent = `Exibindo ${data.length} resultado(s).`;
  }

  // Alternar entre compras e despesas gerais
  function showSection(section) {
    const comprasContainer = document.getElementById("compras-container");
    const despesasContainer = document.getElementById("despesas-container");
    const searchContainer = document.getElementById("search-container");
    const sectionTitle = document.getElementById("despesas-title");

    if (section === "compras") {
      comprasContainer.style.display = "block";
      despesasContainer.style.display = "none";
      searchContainer.style.display = "flex";
      currentSection = "compras";
      currentData = compras;
      renderTable(compras);
    } else if (section === "despesas") {
      comprasContainer.style.display = "none";
      despesasContainer.style.display = "block";
      searchContainer.style.display = "flex";
      currentSection = "despesas";
    }
  }

  // Mostrar despesas de um órgão específico
  function showSpecificDespesas(orgao) {
    showSection("despesas");
    document.querySelectorAll(".despesas-orgao").forEach((section) => {
      section.style.display = "none";
    });
    document.getElementById(`despesas-${orgao}`).style.display = "block";
    document.getElementById("despesas-title").textContent = orgao.split(" ", 1)[1];
  }

  // Carregar a tabela inicial com compras
  showSection("compras");
</script>
{% endblock %}
